name: Deploy Activity Service

on:
  push:
    branches: [main]
    paths:
      - 'backend/activity-service/**'
      - '.github/workflows/deploy-activity-service.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  SERVICE_NAME: petpal-activity-service
  SERVICE_PATH: backend/activity-service
  COSMOS_DATABASE_NAME: activityservice
  COSMOS_CONTAINER_NAME: activities
  RESOURCE_GROUP: ${{ vars.RESOURCE_GROUP }}
  ACR_NAME: ${{ vars.ACR_NAME }}
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}
  CONTAINER_APP_NAME: ${{ vars.ACTIVITY_SERVICE_CONTAINER_APP_NAME }}
  MANAGED_IDENTITY_CLIENT_ID: ${{ vars.ACTIVITY_SERVICE_MI_CLIENT_ID }}
  CONTAINER_APP_FQDN: ${{ vars.ACTIVITY_SERVICE_FQDN }}
  COSMOS_ENDPOINT: ${{ vars.COSMOS_ENDPOINT }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login (federated managed identity)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build and deploy Container App
        uses: azure/container-apps-deploy-action@v1
        with:
          acrName: ${{ env.ACR_NAME }}
          containerAppName: ${{ env.CONTAINER_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          imageToBuild: ${{ env.ACR_LOGIN_SERVER }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          appSourcePath: ${{ github.workspace }}/${{ env.SERVICE_PATH }}
          environmentVariables: >-
            AZURE_CLIENT_ID=${{ env.MANAGED_IDENTITY_CLIENT_ID }}
            COSMOS_ENDPOINT=${{ env.COSMOS_ENDPOINT }}
            COSMOS_DATABASE_NAME=${{ env.COSMOS_DATABASE_NAME }}
            COSMOS_CONTAINER_NAME=${{ env.COSMOS_CONTAINER_NAME }}

  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: build-and-deploy

    steps:
      - name: Wait for rollout
        run: sleep 30

      - name: Health check
        run: |
          echo "Testing health endpoint: ${{ env.CONTAINER_APP_FQDN }}/health"

          # Retry health check up to 5 times
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.CONTAINER_APP_FQDN }}/health" || echo "000")
            if [ "$HTTP_CODE" == "200" ]; then
              echo "✅ Health check passed (HTTP $HTTP_CODE)"
              curl -s "${{ env.CONTAINER_APP_FQDN }}/health" | jq '.'
              exit 0
            else
              echo "⚠️ Attempt $i: Health check returned HTTP $HTTP_CODE, retrying..."
              sleep 10
            fi
          done

          echo "❌ Health check failed after 5 attempts"
          exit 1
